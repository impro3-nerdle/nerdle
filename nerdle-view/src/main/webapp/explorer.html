<!DOCTYPE html>
<html>
	<head>
		<title> Nerdle Explorer </title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<!-- Bootstrap -->

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">

		<!-- Optional theme -->
		<!-- <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css"> -->

		<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
		<![endif]-->
		
		<script id="argument-template" type="text/x-handlebars-template">
  			<div class="form-group">
			    <label for="argument-{{id}}" class="col-sm-2 control-label">Argument {{id}}</label>
			    <div class="col-sm-6">
			      <input type="text" class="form-control" id="argument-{{id}}" placeholder="Argument {{id}}">
			    </div>
			</div>
		</script>
		
		<script id="button-template" type="text/x-handlebars-template">
  			<span class="{{classVal}}" ></span>
		</script>
		
		<script id="message-template" type="text/x-handlebars-template">
  			<div class="alert alert-success"> {{amount}} results found</div>
		</script>
		
		<script id="progress-template" type="text/x-handlebars-template">
  			<div class="progress progress-striped active">
	  			<div class="progress-bar" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
	    			<span class="sr-only"></span>
	  			</div>
			</div>
		</script>
		
		<script id="answers-template" type="text/x-handlebars-template">
  			<table class="table table-hover table-condensed">
					<thead>
						<tr>
							<th>Sentence</th>
							<th>Score</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						 {{#each answers}}
						<tr class="answer-row" data-id="{{@index}}">
							<td data-id="{{@index}}"> 
								{{sentence}}
								<div id="info-{{@index}}" width="100%" data-id="{{@index}}" class="info" style="display: none">
									<canvas id="graph-{{@index}}" data-id="{{@index}}" height="300px" style="overflow: auto" />
									<pre> {{d3GraphJson}} </pre>	
								</div>				
							</td>
							
							<td>{{confidence}}% </td>
							<td><button id="info-button-{{@index}}" data-id="{{@index}}" type="button" class="btn btn-primary info-button"><span class="glyphicon glyphicon-chevron-down" ></span></button></td>
						</tr>
						{{/each}}
					</tbody>
				</table>
		</script>
		
		<style>
			body {
				padding-top: 50px;
			}
			/*.glyphicon, .navbar-header h1 {
				display: inline-block;*/
				/*margin-right: 10px;
			}*/			/*.nerdle .form-control {
				width: 70%;
			}*/
			/*.nerdle .form-control.select {
				display: inline-block;
				width: 150px;
			}*/		
		</style>

	</head>
	<body class="nerdle" >

		<div class="container">

			<h1> Explore the Nerdle Graph </h1>
									
			<form id="form" class="form-horizontal" role="form">
			  <div class="form-group">
			     <label class="col-sm-2 control-label" for="subject">Subject</label>
			    <div class="col-sm-6">
			      <input type="text" class="form-control" id="subject" placeholder="Subject">
			    </div>
			  </div>
			  
			  <div class="form-group">
			    <label for="verb" class="col-sm-2 control-label">Verb</label>
			    <div class="col-sm-6">
			      <input type="text" class="form-control" id="verb" placeholder="Verb">
			    </div>
			  </div>
			  
			  <div id="arguments">
				  <div class="form-group">
				    <label for="argument-1" class="col-sm-2 control-label">Argument 1</label>
				    <div class="col-sm-6">
				      <input type="text" class="form-control" id="argument-1" placeholder="Argument 1">
				    </div>
				  </div>
			  </div>
			  
			  <div class="form-group">
			  	<div class="col-sm-offset-2 col-sm-6">
			  		<button id="addArgument" type="button" class="btn btn-success">Add Argument</button>
					<button id="removeArgument" type="button" class="btn btn-danger">Remove Argument</button>
				</div>
			  </div>
			  
			  <div class="form-group">
			  	<div class="col-sm-offset-2 col-sm-6">
					<select id="wikia" class="form-control select">
						<option value="simpsons">Simpsons</option>
						<option value="memory-beta">Memory Beta</option>
					</select>
				</div>
			  </div>
			  
			  <div class="form-group">
			    <div class="col-sm-offset-2 col-sm-6">
			      <!-- <button type="submit" class="btn btn-default">Sign in</button> -->			      
			      <button id="explore" type="submit" class="btn btn-primary">Explore</button>
			    </div>
			  </div>
			</form>
			
			<h1> Answers </h1>
			
			<div id="message"></div>
			
			<div id="answers">
				
			</div>
			
			<ul class="pager">
				<li class="pager-prev disabled">
					<a id="prev" href="#answers">Previous</a>
				</li>
				<li id="page"></li>
				<li class="pager-next disabled">
					<a id="next" href="#answers">Next</a>
				</li>
			</ul>
			
		</div>
		
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://code.jquery.com/jquery.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<!-- Latest compiled and minified JavaScript -->
		
		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
		<script src="js/springy.js"></script>
		<script src="js/springyui.js"></script>
		
		<script type="text/javascript">
			var argumentSource   = $("#argument-template").html();
			var argumentTemplate = Handlebars.compile(argumentSource);
			
			var buttonSource   = $("#button-template").html();
			var buttonTemplate = Handlebars.compile(buttonSource);
			
			var answersSource   = $("#answers-template").html();
			var answersTemplate = Handlebars.compile(answersSource);
			
			var messageSource   = $("#message-template").html();
			var messageTemplate = Handlebars.compile(messageSource);
			
			var progressSource  = $("#progress-template").html();
			var progressTemplate = Handlebars.compile(progressSource);
			
			$(document).ready(function() {
  				
  				var graphJSON = {
					"nodes" : ["Amphitryon", "Alcmene", "Iphicles", "Heracles"],
					"edges" : [["Amphitryon", "Alcmene"], ["Alcmene", "Amphitryon"], ["Amphitryon", "Iphicles"], ["Amphitryon", "Heracles"]]
				};
  				
  				var array = []
  				
  				array[0] = {sentence: "Lorem ipsum dolor sit amet, utamur aperiam democritum in sea, est id iusto iracundia. Mei suas quot referrentur id. Aliquid iracundia te usu. Lorem ipsum dolor sit amet, utamur aperiam democritum in sea, est id iusto iracundia. Mei suas quot referrentur id. Aliquid iracundia te usu.", 
  					confidence: 0.9, json: JSON.stringify({verb: "A", argument: "B"}), graphJSON: graphJSON};
  					
  				array[1] = {sentence: "Lorem ipsum dolor sit amet, utamur aperiam democritum in sea, est id iusto iracundia. Mei suas quot referrentur id. Aliquid iracundia te usu. Lorem ipsum dolor sit amet, utamur aperiam democritum in sea, est id iusto iracundia. Mei suas quot referrentur id. Aliquid iracundia te usu.", 
  					confidence: 0.8, json: JSON.stringify({verb: "C", argument: "D"}), graphJSON: graphJSON};
  				
  				var globalData = {answers: array};
  				  				  				
  				var argumentCount = 1;
  				
  				var page = 1;
  				var pageMax = 1;
  					
  				$( "#addArgument" ).click(function() {
					argumentCount = argumentCount + 1;
					var html    = argumentTemplate({id: argumentCount});
					$("#arguments").append(html)
				});
				
				$( "#removeArgument" ).click(function() {
					if (argumentCount > 1) {
						argumentCount = argumentCount - 1;
						$("#arguments").children().last().remove();
					}
				});
				
				$( "#explore" ).click(function() {
					
					page = 1;
					
					$("#explore").button('loading');
					
					getAjaxAnswers();
					
				});
				
				function getAjaxAnswers() {
				
					var html = progressTemplate();
					$("#answers").html(html);
				
					var data = {};
					data.subject = $("#subject").val();
					data.verb = $("#verb").val();
					data.wikia = $("#wikia").val();
					data.max = 10;
					data.offset = 10*(page-1);
					
					var arguments = []
					
					for (var i = 1; i <= argumentCount; i++) {
					  	arguments[i-1] = $("#argument-" + i).val();
					}
										
					data.arguments = arguments
					
					$.ajax({
						dataType: "json",
						url: "webapi/nerdleExplorer/explore",
						data: data,
						success: function(json) {
							//console.debug(json);
							globalData = json;
							
							pageMax = Math.floor(globalData.answersSize/10);
							
							if (globalData.answersSize%10 != 0) {
								pageMax++;
							}
							
							if (page < pageMax) {
								$(".pager-next").removeClass("disabled");
							}
							
							$("#page").html(page + "/" + pageMax);
							
							fillAnswerTable();
														
							$("#explore").button('reset');
						},
						error : function(e) {
							//console.debug(e);
														
							noAnswersFound();
													
							$("#explore").button('reset');
						},
						traditional: true
					});

				}
				
				function noAnswersFound() {
					var messageHtml = messageTemplate({amount: 0});
					$("#message").html(messageHtml);
					
					$("#answers").html('');
					
					$("#page").html('');
					
					pageMax = 1;					
					$(".pager-next").addClass("disabled");
					$(".pager-prev").addClass("disabled");
				}
								
				function fillAnswerTable() {
					
					if (globalData.answersSize == 0) {
						noAnswersFound();
					} else {
						var messageHtml = messageTemplate({amount: globalData.answersSize});
						$("#message").html(messageHtml);
						
						var html = answersTemplate(globalData);
						$("#answers").html(html);
						
						for (var i = 0; i < globalData.answers.length; i++) {
						  	var divWidth = $("td[data-id='" + i + "']").width();
						  	$("canvas[data-id='" + i + "']").attr("width", "" + divWidth + "px");
						  	
							var graph = new Springy.Graph();
							graph.loadJSON(globalData.answers[i].graphJSON);
	
							var springy = $("canvas[data-id='" + i + "']").springy({
								graph : graph
							});
						}
								
						addClickListenerToAnswerRows();
					}
				}
				
				/* ANSWER ROW CLICK LISTENER */
				
				function addClickListenerToAnswerRows() {					
					$(".answer-row").click(function() {
						var dataId = $(this).data("id");
						$("div[data-id='" + dataId + "']").filter('.info').toggle();
						
						var button = $("button[data-id='" + dataId + "']").filter('.info-button');
						
						if (button.children().first().hasClass("active")) {
							var html = buttonTemplate({classVal: "glyphicon glyphicon-chevron-down"});
							$(button).html(html);
						} else {
							var html = buttonTemplate({classVal: "glyphicon glyphicon-chevron-up active"});
							$(button).html(html);
						}
					});
				}				
				
				/* PAGINATION */
								
				$("#prev").click(function() {
					if (!$(".pager-prev").hasClass("disabled")) {
						if (page > 1) {
							page--;
							getAjaxAnswers();
						}
						
						if (page == 1) {
							$(".pager-prev").addClass("disabled");
						}
						
						if (page < pageMax) {
							$(".pager-next").removeClass("disabled");
						}
						
						$("#page").html(page + "/" + pageMax);						
					}
				});
				
				$("#next").click(function() {
					
					if (!$(".pager-next").hasClass("disabled")) {
						if (page < pageMax) {
							page++;
							getAjaxAnswers();
						}
						
						if (page == pageMax) {
							$(".pager-next").addClass("disabled");
						}
						
						if (page > 1) {
							$(".pager-prev").removeClass("disabled");
						}
						
						$("#page").html(page + "/" + pageMax);	
					}
				});
				
				/* OTHER */
				
				$("#form").submit(function(event) {
					event.preventDefault();
				});

			});

		</script>
		
	</body>
</html>

