<!DOCTYPE html>
<HTML>
	<HEAD>
		<TITLE>Nerdle View</TITLE>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">

		<!-- Optional theme -->
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css">
		<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>

		<script id="button-template" type="text/x-handlebars-template">
			<span class="{{classVal}}" ></span>
		</script>

		<script id="answer-template" type="text/x-handlebars-template">
			{{log "Look at me!"}}
			{{log group}}
			<div class="panel panel-primary">
			<div class="panel-heading">
			<h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion" class="collapsed" href="#collapse-{{idx}}" >  {{group.subject}} </a></h4>
			</div>
			<div id="collapse-{{idx}}" class="panel-collapse collapse">
			<table class="table table-hover table-condensed">
			<thead>
			<tr>
			<th>Sentence</th>
			<th>Score</th>
			<th></th>
			</tr>
			</thead>
			<tbody>
			{{#each group.answers}}
			{{log group.answers}}
			<tr class="answer-row" data-id="{{@index}}-{{../idx}}">
			<td data-id="{{@index}}-{{../idx}}">
			{{sentence}}
			<div id="info-{{@index}}" width="100%" data-id="{{@index}}-{{../idx}}" class="info" style="display: none">
			<div id="graph-{{@index}}-{{../idx}}" data-id="{{@index}}-{{../idx}}" height="300px" style="overflow: auto" ></div>
			<pre> {{d3GraphJson}} </pre>
			<a href="{{url}}">Link to Wikiapage</a>
			</div>
			</td>

			<td>{{confidence}}</td>
			<td><button id="info-button-{{@index}}" data-id="{{@index}}-{{../idx}}" type="button" class="btn btn-primary info-button"><span class="glyphicon glyphicon-chevron-down" ></span></button></td>
			</tr>
			{{/each}}
			</tbody>
			</table>
			</div>
			</div>
		</script>
		<style>
			.link {
				fill: none;
				stroke: #666;
				stroke-width: 1.5px;
			}

			#licensing {
				fill: green;
			}

			circle {
				fill: #FF9933;
			}
			
			circle.Synonym{
				
			}
			
			circle.Lemma{
				fill: #FFC1C1;
			}
			
			circle.P {
				fill: #FF7F24;
			}

			circle.L {
				fill: #33CCFF;
			}

			circle.T {
				fill: #33CC33;
			}

			circle.S {
				fill: #BCE910;
			}

			circle.noNer {
				fill: #ccc;
			}

			text {
				font: 10px sans-serif;
				pointer-events: none;
				text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
			}

		</style>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script>
			$(document).ready(function() {

			});
		</script>
		<style>
			.nerdle {
				width: 100%;
				height: 100% padding : 0;
				margin: 0;
			}
			.nerdle .list-group {
				margin-bottom: 0;
			}

			#sentenceButton, #sentenceValue {
				display: inline-block;
			}
			.nerdle .form-control {
				width: 70%;
			}
			.nerdle .form-control.select {
				display: inline-block;
				width: 150px;
			}
			#inputSentence {
				padding-top: 50px;
				padding-bottom: 50px;
				border-bottom: 1px solid lightgray;
			}
			#loadingDiv {
				display: none;
			}
			.list-group-item {
				cursor: pointer;
			}

			#outputSentence ul {
				min-height: 200px;
			}

			.nerdle .page-header {
				margin: 0;
				padding: 20px 10px;
				background: #BCE8F1;
			}

			.nerdle .page-header h1 {
				margin: 0;
				padding: 0;
			}
			.nerdle .header-container {
				margin-left: 50px;
			}

			.line {
				border-bottom: 1px solid black;
				width: 100%;
				height: 1px;
			}
		</style>
		<script type="text/javascript">
			function getGremlin() {
				
				
				var testResponse = {

					"groupedAnswers" : [{

						"subject" : "Barney",

						"answers" : [{

							"sentence" : "Legs mentions that he has a sister, and says that Barney takes pictures of her, and it is implied that he hates Barney for that.",

							"d3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",

							"questionD3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",

							"graphJSON" : "",

							"confidence" : 0.5

						}]

					}, {

						"subject" : "Lisa",

						"answers" : [{

							"sentence" : "Legs mentions that he has a sister, and says that Barney takes pictures of her, and it is implied that he hates Barney for that.",

							"d3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",

							"questionD3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",

							"graphJSON" : "",

							"confidence" : 0.3

						}, {

							"sentence" : "Legs mentions that he has a sister, and says that Barney takes pictures of her, and it is implied that he hates Barney for that.",

							"d3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",

							"questionD3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",
							"graphJSON" : "",

							"confidence" : 0.8

						}, {

							"sentence" : "Legs mentions that he has a sister, and says that Barney takes pictures of her, and it is implied that he hates Barney for that.",

							"d3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",

							"questionD3GraphJson" : "[{\"source\":\"takes\",\"target\":\"takes\",\"ner\":\"\",\"argumentType\":\"V\"},{\"source\":\"takes\",\"target\":\"pictures of her\",\"ner\":\"\",\"argumentType\":\"A\"}]",

							"graphJSON" : "",

							"confidence" : 0.5

						}]

					}]

				};



				$(document).ready(function() {

					function createGraphView(links, canvasId) {

						var nodes = {};

						// Compute the distinct nodes from the links.
						links.forEach(function(link) {
							link.source = nodes[link.source] || (nodes[link.source] = {
								name : link.source,
								ner : link.ner,
								argumentType : link.argumentType
							});
							link.target = nodes[link.target] || (nodes[link.target] = {
								name : link.target,
								ner : link.ner,
								argumentType : link.argumentType
							});
						});
                        console.debug(nodes);
						var height = 400;
						var fullWidth= $(".panel").width();
						
						var width = (fullWidth/2)-(fullWidth*10/100);
						console.debug(width);

						var force = d3.layout.force().nodes(d3.values(nodes)).links(links).size([width, height]).linkDistance(150).charge(-250).on("tick", tick).start();

						var svg = d3.select("#" + canvasId).append("svg").attr("width", width).attr("height", height);

						// Per-type markers, as they don't inherit styles.
						svg.append("defs").selectAll("marker").data(["S", "A"]).enter().append("marker").attr("id", function(d) {
							return d;
						}).attr("viewBox", "0 -5 10 10").attr("refX", 15).attr("refY", -1.5).attr("markerWidth", 6).attr("markerHeight", 6).attr("orient", "auto").append("path").attr("d", "M0,-5L10,0L0,5");

						var path = svg.append("g").selectAll("path").data(force.links()).enter().append("path").attr("class", function(d) {
							return "link " + d.argumentType;
						});

						var circle = svg.append("g").selectAll("circle").data(force.nodes()).enter().append("circle").attr("r", 10).attr("class", function(d) {
							if (d.ner == "" && d.argumentType != "V") {
								d.ner = "noNer";
							}
							if (d.argumentType == "S") {
								d.ner = "S";
							}
                            if(d.argumentType == "Lemma"){
                                d.ner = "Lemma";
                            }
                            if(d.argumentType == "Synonym"){
                                d.ner = "Synonym";
                            }
							return d.ner;
						}).call(force.drag);

						var text = svg.append("g").selectAll("text").data(force.nodes()).enter().append("text").attr("x", 15).attr("y", ".31em").text(function(d) {
							return d.name;
						});

						// Use elliptical arc path segments to doubly-encode directionality.
						function tick() {
							path.attr("d", linkArc);
							circle.attr("transform", transform);
							text.attr("transform", transform);
						}

						function linkArc(d) {
							var dx = d.target.x - d.source.x, dy = d.target.y - d.source.y, dr = Math.sqrt(dx * dx + dy * dy);
							return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
						}

						function transform(d) {
							return "translate(" + d.x + "," + d.y + ")";
						}

					}
					var json = testResponse;

					$.ajax({
						headers : {
							Accept : "application/javascript; charset=utf-8",
							"Content-Type" : "application/javascript; charset=utf-8"
						},
						type : 'GET',
						url : "webapi/nerdleAnswerer/answer?jsonpCallback=?",
						data : {
							"sentence" : $('#sentenceValue').val(),
							"wikia" : $('#wikiaSelection').val()
						},
						async : true,
						contentType : "application/javascript; charset=utf-8",
						dataType : "jsonp",
						// success : function(json) {
							// console.debug(json);
							// $.each(json.groupedAnswers, function(index, value) {
								// fillAnswerTable(index, value);
// 
							// });
							// addClickListenerToAnswerRows();
						// },
						
						success : function(json) {
							console.debug(json);
							$.each(json.groupedAnswers, function(index, value) {
								fillAnswerTable(index, value);

							});
							addClickListenerToAnswerRows();
						},
						error : function(e) {
							console.debug(json);
						}
					});

					var buttonSource = $("#button-template").html();
					var buttonTemplate = Handlebars.compile(buttonSource);

					function fillAnswerTable(index, groupedAnswers) {
						var html = answersTemplate({
							group : groupedAnswers,
							idx : index
						});
						$("#accordion").append(html);

						for (var i = 0; i < groupedAnswers.answers.length; i++) {
							var divWidth = $("td[data-id='" + i + "-" + index + "']").width();
							$("#graph-" + i + "-" + index).attr("width", "" + divWidth + "px");

							var canvas = $("#graph-" + i + "-" + index);

							var graphLinks = JSON.parse(groupedAnswers.answers[i].d3GraphJson);
							var questionGraphLinks = JSON.parse(groupedAnswers.answers[i].questionD3GraphJson);

							var canvasId = "graph-" + i + "-" + index;

							createGraphView(graphLinks, canvasId);
							createGraphView(questionGraphLinks, canvasId);
						}
					}

					/* ANSWER ROW CLICK LISTENER */

					function addClickListenerToAnswerRows() {
						$(".info-button").click(function() {
							var dataId = $(this).data("id");
							console.debug(dataId);
							$("div[data-id='" + dataId + "']").filter('.info').toggle();

							var button = $("button[data-id='" + dataId + "']").filter('.info-button');

							if (button.children().first().hasClass("active")) {
								var html = buttonTemplate({
									classVal : "glyphicon glyphicon-chevron-down"
								});
								$(button).html(html);
							} else {
								var html = buttonTemplate({
									classVal : "glyphicon glyphicon-chevron-up active"
								});
								$(button).html(html);
							}
						});
					}

				});
			}


			$.ajaxSetup({
				beforeSend : function() {
					$('#accordion').html('');
					$('#loadingDiv').show();
				},
				complete : function() {
					$('#loadingDiv').hide();
				},
				success : function() {
					$('#loadingDiv').hide();
				},
				error : function(){
					$('#loadingDiv').hide();
				}
			});
		</script>

	</HEAD>
	<BODY class="nerdle">
		<div class="header-container">
			<div class="page-header">
				<h1>Nerdle</h1>
			</div>
		</div>
		<div id="inputSentence" class="container">
			<h3>Question</h3>
			<input id="sentenceValue" type="text" class="form-control" placeholder="Type in your question for nerdle">
			<button class="btn btn-primary" id="sentenceButton" onclick="getGremlin()" type="button">
				Send
			</button>
			<h3>Select Wikia</h3>
			<select id="wikiaSelection" class="form-control select">
                <option value="simpsons">Simpsons</option>
				<option value="memory-beta">Memory Beta</option>
			</select>
		</div>
		<div id="outputSentence" class="container">
			<h3>Answers</h3>
			<div id="loadingDiv"><img src="http://preloaders.net/preloaders/287/Filling%20broken%20ring.gif"> loading...
			</div>
			<div class="panel-group" id="accordion"></div>
		</div>

		<div id="testGraph"></div>

		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.3.0/handlebars.min.js"></script>
		<script>
			var answersSource = $("#answer-template").html();
			var answersTemplate = Handlebars.compile(answersSource);
		</script>
	</BODY>
</HTML>
